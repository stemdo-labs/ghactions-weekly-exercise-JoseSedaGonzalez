name: CD - Deploy Docker Image

on:
  workflow_run:
    workflows: ["CI - Build and Docker Push"]
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Get package version
        id: version
        run: echo "VERSION=$(node -p "require('./package.json').version")" >> $GITHUB_ENV

      - name: Pull Docker image
        run: |
          docker pull ${{ vars.DOCKER_USERNAME }}/mi-app-angular:$VERSION

      - name: Deploy to Nginx
        run: |
          docker run -d -p 80:80 ${{ vars.DOCKER_USERNAME }}/mi-app-angular:$VERSION
          curl -f http://localhost:80 || exit 1

